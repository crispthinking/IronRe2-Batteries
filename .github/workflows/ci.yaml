name: Build RE2/cre2

on:
 push:
   branches:
     - main
 pull_request:
   branches:
     - main
 workflow_dispatch:
 workflow_call:  # Allows the workflow to be called by other workflows

permissions:
 contents: write
 pull-requests: write
 checks: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            runtime: linux-x64
          - os: windows-latest
            runtime: win-x64
          - os: macos-latest
            runner: macos-latest      # Default GitHub-hosted runner (Intel)
            runtime: osx-x64
          - os: macos-arm
            runner: macos-arm         # Must correspond to your self-hosted ARM runner.
            runtime: osx-arm64
    runs-on: ${{ matrix.runner || matrix.os }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
    
      - name: Add GitHub Packages NuGet Source
        run: dotnet nuget add source --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/crispthinking/index.json"
    
      - name: Restore dependencies
        run: dotnet restore IronRe2.sln
    
      - name: Build
        run: dotnet build IronRe2.sln --configuration Release --no-restore

      - name: Test
        run: dotnet test IronRe2.sln --configuration Release --no-build --logger "trx" --logger "console;verbosity=normal"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: "**/*.trx"

      - name: Pack
        run: dotnet pack IronRe2.sln --configuration Release --no-build --runtime ${{ matrix.runtime }} --output Artifacts

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.os }}
          path: Artifacts/*.nupkg